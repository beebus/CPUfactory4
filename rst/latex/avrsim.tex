\documentclass[preview]{standalone}
\usepackage{tikz}
\usepackage{cpushapes}

\begin{document}
\begin{tikzpicture}
%--------------------------------------------------------------------

  % fetch
  \muxa{2,1}{green}{mux1}
  \pc{4,0.5}{green}{pc}
  \im{7,0.5}{green}{im}

  % decode
  \dec{9,-1.5}{green}{dec}
  \rf{11,0.5}{green}{rf}

  % execute
  \muxa{14,0}{green}{mux2}
  \muxa{14,3.25}{green}{mux3}
  \alu{17,0.5}{green}{alu}

  %store
  \muxa{21,0.5}{green}{mux4}
  \muxb{23,6}{green}{mux5}
  \muxc{23,-7}{green}{mux6}
  \dm{23,0}{green}{dm}
  \sm{23,4.0}{green}{stk}
  \io{23,-2}{green}{i/o}

  \pin{0.872,1.375}{yellow}{0}  % reset addr

% wires ------------------------------
  \draw (1.75,2.5)      % (w1) pcnext: mux5.4 -> mux1.1
    -- (1,2.5) 
    -- (1,10)
    -- (25,10)
    -- (25,7.5)
    -- (24.25,7.5);

  \draw (1.75,1.5)      % (w2) reset -> mux1.2
    -- (1,1.5);           
  
  \draw (3.25,2.0)      % (w3) pcnext: mux1.3 -> pc.1
    -- (3.75,2.0);
  
  \draw (5.25,2.0)      % (w4) pcnext:  pc.2 -> im.1
    -- (6.75,2.0);
  
  \draw (6.0,2.0)       % (w4) pcnext: pc.2 -> dec.1
    -- (6.0,4.75)    
    -- (8.75,4.75);
  \jct{6.0,2.0};
  
  \draw (8.25,1.5)      % (w5) i2: im.2 -> dec.3 
    -- (8.75,1.5);
  
  \draw (8.25,2.5)      % (w6) i1: im.3 -> dec.2
    -- (8.75,2.5);
  
  \draw (10.25,1.5)     % (w7) Rd:  dec.7 -> rf.2
    -- (10.75,1.5);
  
  \draw (10.25,2.5)     % (w8) Rr  dec.8 -> rf.1
    -- (10.75,2.5);

  \draw (12.25,1.5)     % (w9) [Rd]: rf.4 -> mux2.1
    -- (13.75,1.5);

  \draw(12.25,2.5)      % (w10) [Rr] rf.5 -> mux3.2 
    -- (13.25,2.5) 
    -- (13.25,3.75)
    -- (13.75,3.75);
  
  \draw (13.25,2.5)     % (w10) [Rr]: rf.5 -> io.1
    -- (13.25,-1.5) 
    -- (22.75,-1.5);
  \jct{13.25,2.5}
  
  \draw (20.75, 1.0)    % (w10) [Rr]: rf.5 -> mux4.2
    -- (20,1.0) 
    -- ( 20, -1.5);
  \jct{20,-1.5}
  
  \draw (20,-1.5)       % (w10) [Rr]: rf.5 -> mux6.1 
    -- (20,-3.5) 
    -- (25,-3.5) 
    -- (25,-4.5) 
    -- (24.25,-4.5);

  \draw (10.25, -0.5)   % (w11) k: dec.6 - mux2.2
    -- (12.75,-0.5) 
    -- (12.75,0.5) 
    -- (13.75,0.5);
  \jct{12.75,-0.5}
  

  \draw( 12.75, -0.5)   % (w11) k: dec.6 -> dm.4
    -- (23.5,-0.5) 
    -- (23.5,-0.25); 

  \draw (15.25,1)       % (w12) Ad2: mux2.3 -> alu.2
    -- (16,1) 
    -- (16,1.25)
    -- (16.75,1.25);
 
  \draw(10.25,4.75)     % (w13) PC+1: dec.9 -> mux3.1 
    -- (13.75,4.75);
  
  \draw (12.75,4.75)    % (w13) pc+1: dec.9 -> mux5.1
    -- (12.75,8.5) 
    -- (22.75,8.5);
  \jct{12.75,4.75}

  \draw (15.25,4.25)    % (w14) Ad1: mux3.3 -> alu.1
    -- (16,4.25)
    -- (16,3.75)
    -- (16.75,3.75);
  
  \draw(10.25,5.75)     % (w15) aluop: dec.10 -> alu.op
    -- (18,5.75) 
    -- (18,4.375);
  
  \draw (19.25,3.0)     % (w16) Ares16: alu16.4 -> mux5.2
    -- (20,3.0) 
    -- (20,7.5) 
    -- (22.75,7.5);

  \draw (19.25,2.0)     % (w17) Ares8: alu8.3 -> mux4.1
    -- (20.75, 2.0);


  
  \draw (10.25,-1.0)    % (w18) A: dec.5 -> i/o.2
    -- (12.75,-1.0)
    -- (12.75, -3) 
    -- (21,-3) 
    -- (23.5,-3)
    -- (23.5,-2.250);

  \draw (22.25,1.5)     % (w19) MDR: mux4.3 -> dm.1
    -- (22.75,1.5); 
 
  \draw (22.75,4.5)     % (w20) push: pc+1 -> stk.1
    -- (21,4.5)
    -- (21,8.5);
  \jct{21,8.5}

  \draw (22.75, 6.5)    % (w21) pop: stk.2 -> mux5.3
    -- (22,6.5)
    -- (22,5.5)
    -- (25,5.5)
    -- (25,4.5)
    -- (24.25,4.5);

  \draw (24.25,1)     % (w22) dmout8: dm.2 -> mux6.3
    -- (26.5,1)
    -- (26.5,-6.5)
    -- (24.25,-6.5);
    
  \draw (24.25,-1.5)  % (w23) [A]: i/o.3 -> mux6.2
    -- (26,-1.5) 
    -- (26,-5.5) 
    -- (24.25,-5.5);
    
  \draw (22.75,-5.5)  % (w24) [Rdnext]: mux6.4 -> rf.3
    -- (11.5,-5.5)
    -- (11.5, 0.5);

  % stage barriers:

  % Fetch/Decode:
  \draw[thin, dashed] (8.5,10) -- (8.5, -7);

  % decode/execute
  \draw[thin, dashed] (13.5,10) -- (13.5,-7);

  % execute/Store
  \draw[thin,dashed] (19.625,10) -- (19.625,-7);
 %-----------------------------------------------------------------------------
\end{tikzpicture}
\end{document}

